services:
  localstack:
    image: localstack/localstack
    container_name: localstack
    ports:
      - "4566:4566"
    environment:
      - SERVICES=s3,dynamodb,sqs,lambda,apigateway
      - DEBUG=1
      - PERSISTENCE=1
      - AWS_DEFAULT_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - EXTRA_CORS_ALLOWED_ORIGINS=*
    volumes:
      # 持久化（在 infra 目录执行，所以这里就是 infra/.localstack）
      - "./.localstack:/var/lib/localstack"
      - "/var/run/docker.sock:/var/run/docker.sock"

  # 1) 初始化 S3/DDB/SQS + CORS
  localstack-init:
    image: amazon/aws-cli:2.15.40
    container_name: localstack-init
    depends_on:
      - localstack
    volumes:
      - "./localstack/init.sh:/init.sh:ro"
    entrypoint: ["/bin/sh", "-lc", "/init.sh"]
    environment:
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_DEFAULT_REGION=us-east-1

  # 2) 生成 Lambda zip（在项目根 lambdas/create-annonce 下生成 create-annonce.zip）
  lambda-build:
    image: node:20-alpine
    container_name: lambda-build
    depends_on:
      - localstack-init
    volumes:
      # ✅ 关键：挂载项目根目录（infra 的上一级）
      - "..:/workspace"
    working_dir: /workspace/lambdas/create-annonce
    entrypoint:
      - /bin/sh
      - -lc
      - |
        apk add --no-cache zip >/dev/null
        npm install
        npm run build:zip
        echo "==> ZIP prêt: /workspace/lambdas/create-annonce/create-annonce.zip"

  # 3) 部署/更新 Lambda 到 LocalStack（无需 Terraform）
  lambda-deploy:
    image: amazon/aws-cli:2.15.40
    container_name: lambda-deploy
    depends_on:
      - lambda-build
    volumes:
      - "..:/workspace"
    entrypoint:
      - /bin/sh
      - -lc
      - |
        set -e
        AWS="aws --endpoint-url=http://localstack:4566 --region us-east-1"
        ZIP="/workspace/lambdas/create-annonce/create-annonce.zip"

        echo "==> Wait zip..."
        while [ ! -f "$ZIP" ]; do sleep 1; done
        echo "==> Zip OK"

        # FR: Si la fonction existe -> update, sinon -> create
        # CN: 如果函数已存在就更新，否则创建
        if $AWS lambda get-function --function-name create-annonce >/dev/null 2>&1; then
          echo "==> Lambda existe -> update-function-code"
          $AWS lambda update-function-code \
            --function-name create-annonce \
            --zip-file fileb://$ZIP >/dev/null
        else
          echo "==> Lambda absente -> create-function"
          $AWS lambda create-function \
            --function-name create-annonce \
            --runtime nodejs18.x \
            --handler index.handler \
            --role arn:aws:iam::000000000000:role/lambda-role \
            --zip-file fileb://$ZIP >/dev/null
        fi

        echo "==> Lambda déployée ✅"
    environment:
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_DEFAULT_REGION=us-east-1