services:
  localstack:
    image: localstack/localstack
    container_name: localstack
    ports:
      - "4566:4566"
    environment:
      - SERVICES=s3,dynamodb,sqs,lambda,apigateway
      - DEBUG=1
      - PERSISTENCE=1
      - AWS_DEFAULT_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - EXTRA_CORS_ALLOWED_ORIGINS=*
    volumes:
      # 在 infra/ 执行 compose，所以这里 ./ 就是 infra/
      - "./.localstack:/var/lib/localstack"
      - "/var/run/docker.sock:/var/run/docker.sock"

  # 1) 初始化 S3/DDB/SQS + 配置 S3 CORS
  localstack-init:
    image: amazon/aws-cli:2.15.40
    container_name: localstack-init
    depends_on:
      - localstack
    volumes:
      - "./localstack/init.sh:/init.sh:ro"
    entrypoint: ["/bin/sh", "-lc", "sh /init.sh"]
    environment:
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_DEFAULT_REGION=us-east-1

  # 2) 生成 Lambda zip（输出固定在 /workspace/lambdas/create-annonce/create-annonce.zip）
  lambda-build:
    image: node:20-alpine
    container_name: lambda-build
    depends_on:
      - localstack-init
    volumes:
      # 关键：挂载项目根目录（infra 的上一级）
      - "..:/workspace"
    working_dir: /workspace/lambdas/create-annonce
    entrypoint:
      - /bin/sh
      - -lc
      - |
        set -e
        apk add --no-cache zip >/dev/null
        npm install
        npm run build:zip
        ls -la /workspace/lambdas/create-annonce
        test -f /workspace/lambdas/create-annonce/create-annonce.zip
        echo "==> ZIP prêt ✅ /workspace/lambdas/create-annonce/create-annonce.zip"

  # 3) 部署/更新 Lambda 到 LocalStack（自动 create 或 update）
  lambda-deploy:
    image: amazon/aws-cli:2.15.40
    container_name: lambda-deploy
    depends_on:
      - lambda-build
    volumes:
      - "..:/workspace"
    entrypoint:
      - /bin/sh
      - -lc
      - |
        set -e
        AWS="aws --endpoint-url=http://localstack:4566 --region us-east-1"
        ZIP="/workspace/lambdas/create-annonce/create-annonce.zip"

        echo "==> Wait zip..."
        while [ ! -f "$$ZIP" ]; do sleep 1; done
        echo "==> Zip OK: $$ZIP"

        if $$AWS lambda get-function --function-name create-annonce >/dev/null 2>&1; then
          echo "==> Lambda existe -> update-function-code"
          $$AWS lambda update-function-code \
            --function-name create-annonce \
            --zip-file fileb://$$ZIP >/dev/null
        else
          echo "==> Lambda absente -> create-function"
          $$AWS lambda create-function \
            --function-name create-annonce \
            --runtime nodejs18.x \
            --handler index.handler \
            --role arn:aws:iam::000000000000:role/lambda-role \
            --zip-file fileb://$$ZIP >/dev/null
        fi

        echo "==> Lambda déployée ✅"
    environment:
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_DEFAULT_REGION=us-east-1